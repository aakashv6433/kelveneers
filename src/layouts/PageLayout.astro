---
import { Image } from "astro:assets";
import hamburgerIcon from "../assets/icons/hamburger.svg";
import hamburgerIconHover from "../assets/icons/hamburger_hover_orange_variant.svg";
import kelveneersIcon from "../assets/secondary-logo.svg";
import kelveneersIconHover from "../assets/secondary-logo-hover-orange-variant.svg";
import Footer from "../components/common/Footer.astro";
import "../styles/global.css";

interface Props {
  title?: string;
  footerBgColor?: string;
}

const { title = "kelveneers", footerBgColor } = Astro.props;
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <link
      rel="icon"
      type="image/svg+xml"
      href={`${import.meta.env.BASE_URL}favicon.svg`}
    />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <!-- page-specific head content (preload links, meta tags) -->
    <slot name="head" />
    <script>
      // Scroll to top on page load/refresh
      if ("scrollRestoration" in history) {
        history.scrollRestoration = "manual";
      }
      window.scrollTo(0, 0);
    </script>
  </head>

  <body>
    <!-- Site loader shown on initial page load; now hides when ~70% of main content is ready -->
    <div id="site-loader" class="site-loader">
      <div class="site-loader__inner" role="status" aria-label="Loading">
        <div class="site-loader__ring" aria-hidden="true">
          <svg class="site-loader__ring-svg" viewBox="0 0 100 100">
            <circle
              cx="50"
              cy="50"
              r="45"
              fill="none"
              stroke="#d85f3e"
              stroke-width="5"
              stroke-linecap="round"
              stroke-dasharray="50 230"></circle>
          </svg>
          <svg
            class="site-loader__logo"
            viewBox="110 110 860 870"
            xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink"
            aria-label="Kelveneers"
          >
            <defs>
              <style>
                .cls-1 {
                  fill: none;
                }
                .cls-2 {
                  fill: #e96a4d;
                }
                .cls-3 {
                  fill: #d85f3e;
                }
                .cls-4 {
                  clip-path: url(#clippath);
                }
              </style>
              <clipPath id="clippath">
                <rect
                  class="cls-1"
                  x="593.79"
                  y="736.08"
                  width="83.22"
                  height="83.22"></rect>
              </clipPath>
            </defs>
            <g class="cls-4">
              <path
                class="cls-2"
                d="M629.78,766.61h5.51c1.84,0,3.21.44,4.1,1.34.89.9,1.33,2.14,1.33,3.71,0,.74-.11,1.42-.34,2.02-.23.6-.57,1.12-1.02,1.55-.45.44-1.01.77-1.69,1.01-.68.24-1.47.36-2.37.36h-5.53v-9.99ZM622.91,761.05v33.29h6.86v-12.19h5.47l6.24,12.19h7.36v-.32l-7.2-13.61c.91-.41,1.74-.9,2.47-1.46.73-.56,1.36-1.23,1.88-1.98s.91-1.62,1.19-2.58c.27-.97.41-2.06.41-3.28,0-1.65-.28-3.1-.85-4.35-.56-1.25-1.37-2.29-2.42-3.14-1.05-.85-2.34-1.49-3.87-1.93-1.53-.44-3.25-.65-5.17-.65h-12.37ZM635.4,744.4c18.43,0,33.29,14.86,33.29,33.29s-14.86,33.29-33.29,33.29-33.29-14.86-33.29-33.29,14.86-33.29,33.29-33.29ZM635.4,736.08c-22.93,0-41.61,18.68-41.61,41.61s18.68,41.61,41.61,41.61,41.61-18.68,41.61-41.61-18.68-41.61-41.61-41.61Z"
              ></path>
            </g>
            <g>
              <path
                class="cls-3"
                d="M540,953.96c-228.26,0-413.97-185.7-413.97-413.96S311.74,126.04,540,126.04s413.97,185.7,413.97,413.97-185.7,413.96-413.97,413.96M540,167.33c-205.5,0-372.67,167.17-372.67,372.67s167.17,372.65,372.67,372.65,372.67-167.17,372.67-372.65-167.17-372.67-372.67-372.67"
              ></path>
              <polygon
                class="cls-2"
                points="542.09 472.58 674.43 304.77 626.88 267.73 494.53 435.55 542.09 472.58"
              ></polygon>
              <polygon
                class="cls-2"
                points="610.25 502.52 664.81 511.83 691.54 362.34 636.98 353.03 610.25 502.52"
              ></polygon>
              <polygon
                class="cls-2"
                points="502.21 478.11 412.19 341.44 368.12 375.63 458.12 512.28 502.21 478.11"
              ></polygon>
              <polygon
                class="cls-2"
                points="559.06 312.46 443.21 275.21 428.24 328.8 544.11 366.04 559.06 312.46"
              ></polygon>
              <polygon
                class="cls-2"
                points="296.7 505.93 483.21 625.68 516.02 577.23 329.5 457.47 296.7 505.93"
              ></polygon>
              <polygon
                class="cls-2"
                points="783.3 491.85 748.49 445.17 576.12 584.03 576.12 486.72 517.33 486.72 517.33 812.25 576.12 812.25 576.12 658.79 783.3 491.85"
              ></polygon>
            </g>
          </svg>
        </div>
      </div>
    </div>
    <!-- Header with background and fixed positioning for scroll behavior -->
    <header
      id="site-header"
      class="fixed top-0 left-1/2 transform -translate-x-1/2 !bg-[#351c24] header-container transition-transform duration-300 ease-in-out"
    >
      <nav
        class="flex items-center justify-between py-2 md:py-0 h-full px-[4.17vw] relative"
      >
        <!-- Logo - LEFT end on desktop -->
        <div class="hidden md:flex items-center logo-container">
          <a
            href={`${import.meta.env.BASE_URL}`}
            class="secondary-logo relative inline-block"
          >
            <Image
              src={kelveneersIcon}
              alt={"Kelveneers Icon"}
              loading={"eager"}
              class="secondary-logo-default logo-icon nav-icon"
            />
            <Image
              src={kelveneersIconHover}
              alt={"Kelveneers Icon Hover"}
              loading={"eager"}
              class="secondary-logo-hover logo-icon nav-icon absolute top-0 left-0 opacity-0"
            />
          </a>
        </div>

        <!-- Mobile Logo - Center on mobile, hidden on md and up -->
        <div
          class="md:hidden flex items-center justify-center absolute left-1/2 transform -translate-x-1/2"
        >
          <a
            href={`${import.meta.env.BASE_URL}`}
            class="secondary-logo relative inline-block"
          >
            <Image
              src={kelveneersIcon}
              alt={"Kelveneers Icon"}
              loading={"eager"}
              class="secondary-logo-default logo-icon nav-icon"
            />
            <Image
              src={kelveneersIconHover}
              alt={"Kelveneers Icon Hover"}
              loading={"eager"}
              class="secondary-logo-hover logo-icon nav-icon absolute top-0 left-0 opacity-0"
            />
          </a>
        </div>

        <!-- Hamburger Icon - RIGHT end on desktop, LEFT on mobile -->
        <div class="flex items-center hamburger-container">
          <button
            type="button"
            aria-label="Hamburger"
            class="bg-transparent border-none cursor-pointer relative"
            id="hamburger-menu"
          >
            <Image
              src={hamburgerIcon}
              alt={"Hamburger Icon"}
              loading={"eager"}
              class="hamburger-icon hamburger-default nav-icon"
            />
            <Image
              src={hamburgerIconHover}
              alt={"Hamburger Icon Hover"}
              loading={"eager"}
              class="hamburger-icon hamburger-hover nav-icon absolute top-0 left-0 opacity-0"
            /></button
          >
        </div>
      </nav>
    </header>

    <!-- Side Menu Overlay - Completely independent of header -->
    <div
      id="side-menu-overlay"
      class="fixed inset-0 z-[1000] hidden transition-all duration-300 pointer-events-none"
      style="background-color: rgba(0, 0, 0, 0.3);"
    >
      <!-- Side Menu - Full viewport height, independent of header -->
      <div
        id="side-menu"
        class="fixed top-0 left-0 md:left-auto md:right-0 w-[80vw] md:w-[50vw] lg:w-[35vw] xl:w-[25vw] transform -translate-x-full md:translate-x-full transition-transform duration-300 ease-in-out shadow-xl z-[1001] overflow-y-auto"
        style="height: 100vh; min-height: 100vh; background-color: #f4f0e0;"
      >
        <!-- Close Button -->
        <div class="px-6 pb-12 md:text-right 2xl:pr-11 pt-9">
          <button
            type="button"
            aria-label="Close Menu"
            class="bg-transparent border-none cursor-pointer font-light transition-colors menu-close-btn"
            id="close-menu"
            style="font-size: 3rem; line-height: 1; padding: 0;"
          >
            Ã—
          </button>
        </div>

        <!-- Menu Items -->
        <div class="px-6 pb-6 min-[440px]:text-center lg:text-left 2xl:pl-10">
          <ul class="space-y-8 md:space-y-10 lg:space-y-12">
            <li class="menu-item opacity-0" style="transition-delay: 0.1s;">
              <a href="/kelveneers/doors" class="no-underline inline-block">
                <span
                  class="font-[Altone] tracking-wide uppercase text-[24px] leading-none transition-colors menu-text menu-link"
                  >DOORS</span
                >
              </a>
            </li>
            <li class="menu-item opacity-0" style="transition-delay: 0.2s;">
              <a href="/kelveneers/windows" class="no-underline inline-block">
                <span
                  class="font-[Altone] tracking-wide uppercase text-[24px] leading-none transition-colors menu-text menu-link"
                  >WINDOWS</span
                >
              </a>
            </li>
            <li class="menu-item opacity-0" style="transition-delay: 0.3s;">
              <a href="/kelveneers/frames" class="no-underline inline-block">
                <span
                  class="font-[Altone] tracking-wide uppercase text-[24px] leading-none transition-colors menu-text menu-link"
                  >FRAMES</span
                >
              </a>
            </li>
            <li class="menu-item opacity-0" style="transition-delay: 0.4s;">
              <a
                href="/kelveneers/architectural-add-on-products"
                class="no-underline inline-block menu-link-group"
              >
                <div class="uppercase min-[440px]:text-center lg:text-left">
                  <div
                    class="font-[Altone] tracking-wide text-[24px] leading-none transition-colors menu-text menu-link-text"
                  >
                    ARCHITECTURAL
                  </div>
                  <div
                    class="font-[Altone] tracking-wide text-[24px] leading-none transition-colors menu-text menu-link-text"
                  >
                    ADD-ON PRODUCTS
                  </div>
                </div>
              </a>
            </li>
            <li class="menu-item opacity-0" style="transition-delay: 0.5s;">
              <a href="/kelveneers/about" class="no-underline inline-block">
                <span
                  class="font-[Altone] tracking-wide uppercase text-[24px] leading-none transition-colors menu-text menu-link"
                  >ABOUT</span
                >
              </a>
            </li>
            <li class="menu-item opacity-0" style="transition-delay: 0.6s;">
              <a href="/kelveneers/contact" class="no-underline inline-block">
                <span
                  class="font-[Altone] tracking-wide uppercase text-[24px] leading-none transition-colors menu-text menu-link"
                  >CONTACT US</span
                >
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </body>

  <style>
    .menu-item {
      transition:
        opacity 0.4s ease-out,
        transform 0.4s ease-out;
      transform: translateX(-20px);
    }

    @media (min-width: 768px) {
      .menu-item {
        transform: translateX(20px);
      }
    }

    .menu-item.animate-in {
      opacity: 1 !important;
      transform: translateX(0) !important;
    }

    .menu-close-btn {
      color: #351c24;
    }

    .menu-close-btn:hover {
      color: #eb7d66;
    }

    .menu-text {
      color: #351c24;
    }

    .menu-link {
      cursor: pointer;
      display: inline-block;
    }

    .menu-link:hover {
      color: #eb7d66 !important;
    }

    /* Ensure anchor tags only take up text space */
    a.inline-block {
      width: fit-content;
    }

    /* Remove any default hover effects from list items */
    .menu-item:hover {
      background: none;
      cursor: default;
    }

    /* Group hover for architectural add-on products */
    .menu-link-group {
      cursor: pointer;
    }

    .menu-link-group:hover .menu-link-text {
      color: #eb7d66 !important;
    }

    @media (hover: hover) {
      /* Hamburger hover effect */
      #hamburger-menu:hover .hamburger-default,
      #hamburger-menu.menu-open .hamburger-default {
        opacity: 0;
      }

      #hamburger-menu:hover .hamburger-hover,
      #hamburger-menu.menu-open .hamburger-hover {
        opacity: 1;
      }

      /* Secondary logo hover effect (matches hamburger behavior) */
      .secondary-logo:hover .secondary-logo-default,
      .secondary-logo.active .secondary-logo-default {
        opacity: 0;
      }

      .secondary-logo:hover .secondary-logo-hover,
      .secondary-logo.active .secondary-logo-hover {
        opacity: 1;
      }
    }

    #side-menu-overlay:not(.hidden) {
      background-color: rgba(0, 0, 0, 0.3) !important;
      pointer-events: auto !important;
    }

    /* Site loader styles */
    .site-loader {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #351c24; /* primary theme color */
      z-index: 2000;
      transition:
        opacity 300ms ease,
        visibility 300ms ease;
      opacity: 1;
      visibility: visible;
    }

    .site-loader.hide {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    .site-loader__inner {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    /* Ring that surrounds the logo and rotates */
    .site-loader__ring {
      display: inline-grid;
      place-items: center;
      width: 96px;
      height: 96px;
      border-radius: 9999px;
      padding: 8px; /* space between logo and ring */
      box-sizing: border-box;
      background: transparent;
      position: relative;
    }

    .site-loader__ring-svg {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      animation: kv-spin 815ms linear infinite;
    }

    .site-loader__logo {
      width: 72px;
      height: auto;
      z-index: 2;
    }

    @keyframes kv-spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Dynamic loader: hide when ~60% of main content images are loaded,
      // with a minimum visible time and a hard timeout fallback.
      try {
        const siteLoader = document.getElementById("site-loader");
        const mainEl = document.querySelector("main");

        if (siteLoader && mainEl) {
          const startTime = performance.now();
          // Pages can still override the *minimum* duration via window.__LOADER_DURATION__
          const minDuration = (window as any).__LOADER_DURATION__ || 650;
          const hardTimeout = minDuration + 1550; // never keep loader longer than this

          const images = Array.from(mainEl.querySelectorAll("img"));

          const total = images.length || 1; // avoid divide by zero
          let loadedCount = 0;
          let loaderHidden = false;

          const hideLoader = () => {
            if (loaderHidden) return;
            const elapsed = performance.now() - startTime;
            const remaining = Math.max(minDuration - elapsed, 0);
            loaderHidden = true;

            setTimeout(() => {
              siteLoader.classList.add("hide");
              setTimeout(() => siteLoader.remove(), 400);
            }, remaining);
          };

          const maybeUpdateProgress = () => {
            const progress = loadedCount / total;

            // When at least 60% of tracked content is ready, hide loader.
            if (progress >= 0.6) {
              hideLoader();
            }
          };

          const onResourceDone = () => {
            loadedCount += 1;
            maybeUpdateProgress();
          };

          // Attach listeners for image load/error events
          images.forEach((img) => {
            if (img.complete) {
              onResourceDone();
              return;
            }

            img.addEventListener("load", onResourceDone, { once: true });
            img.addEventListener("error", onResourceDone, { once: true });
          });

          // In case there are no images or they load extremely fast
          maybeUpdateProgress();

          // Hard fallback: always hide loader after the hard timeout
          setTimeout(() => {
            hideLoader();
          }, hardTimeout);
        }
      } catch (e) {
        // ignore failures - loader is non-critical
        console.error("Loader error:", e);
      }
      const header = document.getElementById("site-header");
      const hamburgerMenu = document.getElementById("hamburger-menu");
      const sideMenuOverlay = document.getElementById("side-menu-overlay");
      const sideMenu = document.getElementById("side-menu");
      const closeMenu = document.getElementById("close-menu");

      let lastScrollY = window.scrollY;
      let isScrollingDown = false;

      // Side menu functionality
      function openMenu() {
        hamburgerMenu?.classList.add("menu-open");
        sideMenuOverlay?.classList.remove("hidden");
        sideMenuOverlay?.classList.remove("pointer-events-none");
        // Allow page scrolling while menu is open - don't set overflow:hidden
        setTimeout(() => {
          sideMenu?.classList.remove(
            "-translate-x-full",
            "md:translate-x-full"
          );
          // Trigger staggered animation for menu items
          const menuItems = document.querySelectorAll(".menu-item");
          menuItems.forEach((item) => {
            item.classList.add("animate-in");
          });
        }, 10);
      }

      function closeMenuHandler() {
        hamburgerMenu?.classList.remove("menu-open");
        sideMenuOverlay?.classList.add("pointer-events-none");
        // Reset menu items animation state
        const menuItems = document.querySelectorAll(".menu-item");
        menuItems.forEach((item) => {
          item.classList.remove("animate-in");
        });

        sideMenu?.classList.add("-translate-x-full", "md:translate-x-full");
        setTimeout(() => {
          sideMenuOverlay?.classList.add("hidden");
        }, 300);
      }

      // Event listeners for side menu
      hamburgerMenu?.addEventListener("click", openMenu);
      closeMenu?.addEventListener("click", closeMenuHandler);
      sideMenuOverlay?.addEventListener("click", (e) => {
        if (e.target === sideMenuOverlay) {
          closeMenuHandler();
        }
      });

      // Close menu on escape key
      document.addEventListener("keydown", (e) => {
        if (
          e.key === "Escape" &&
          !sideMenuOverlay?.classList.contains("hidden")
        ) {
          closeMenuHandler();
        }
      });

      // Scroll functionality
      const onScroll = () => {
        const currentScrollY = window.scrollY;
        const isMobile = window.innerWidth < 768;
        const scrollThreshold = isMobile ? 0 : 80; // Immediate threshold on mobile

        // Determine scroll direction
        if (currentScrollY > lastScrollY && currentScrollY > 100) {
          // Scrolling down and past 100px - hide navbar
          if (!isScrollingDown) {
            header?.classList.add("header--hidden");
            isScrollingDown = true;
          }
        } else if (currentScrollY < lastScrollY) {
          // Scrolling up - show navbar
          if (isScrollingDown) {
            header?.classList.remove("header--hidden");
            isScrollingDown = false;
          }
        }

        // Add scrolled class for background change
        if (currentScrollY > scrollThreshold) {
          header?.classList.add("header--scrolled");
        } else {
          header?.classList.remove("header--scrolled");
        }

        lastScrollY = currentScrollY;
      };

      onScroll();
      window.addEventListener("scroll", onScroll, { passive: true });
    });
  </script>
</html>

<!-- Main Content Slot -->
<main class="pt-[40px] md:pt-[60px] lg:pt-[70px] xl:pt-[90px]">
  <slot />
</main>

<Footer bgColor={footerBgColor} />
