---
import { Image } from "astro:assets";
import PageLayout from "../layouts/PageLayout.astro";
import clienteleHero from "../assets/clientele_hero.png";

// Import all client logos (1-32)
import client1 from "../assets/clientele/1.png";
import client2 from "../assets/clientele/2.png";
import client3 from "../assets/clientele/3.png";
import client4 from "../assets/clientele/4.png";
import client5 from "../assets/clientele/5.png";
import client6 from "../assets/clientele/6.png";
import client7 from "../assets/clientele/7.png";
import client8 from "../assets/clientele/8.png";
import client9 from "../assets/clientele/9.png";
import client10 from "../assets/clientele/10.png";
import client11 from "../assets/clientele/11.png";
import client12 from "../assets/clientele/12.png";
import client13 from "../assets/clientele/13.png";
import client14 from "../assets/clientele/14.png";
import client15 from "../assets/clientele/15.png";
import client16 from "../assets/clientele/16.png";
import client17 from "../assets/clientele/17.png";
import client18 from "../assets/clientele/18.png";
import client19 from "../assets/clientele/19.png";
import client20 from "../assets/clientele/20.png";
import client21 from "../assets/clientele/21.png";
import client22 from "../assets/clientele/22.png";
import client23 from "../assets/clientele/23.png";
import client24 from "../assets/clientele/24.png";
import client25 from "../assets/clientele/25.png";
import client26 from "../assets/clientele/26.png";
import client27 from "../assets/clientele/27.png";
import client28 from "../assets/clientele/28.png";
import client29 from "../assets/clientele/29.png";
import client30 from "../assets/clientele/30.png";
import client31 from "../assets/clientele/31.png";
import client32 from "../assets/clientele/32.png";

const architectClients = [
  client1,
  client2,
  client3,
  client4,
  client5,
  client6,
  client7,
  client8,
  client9,
  client10,
  client11,
  client12,
  client13,
  client14,
  client15,
  client16,
];
const builderClients = [
  client17,
  client18,
  client19,
  client20,
  client21,
  client22,
  client23,
  client24,
  client25,
  client26,
  client27,
  client28,
  client29,
  client30,
  client31,
  client32,
];

// Choose a small highlighted subset (first 8) for lighter above-the-fold work
const highlightedArchitectClients = architectClients.slice(0, 10);

// Set custom loader duration for this page
// We keep this modest since we've reduced above-the-fold image work.
const loaderDuration = 700;
---

<PageLayout title="Clientele â€¢ Kelveneers">
  <script slot="head" define:vars={{ loaderDuration }}>
    window.__LOADER_DURATION__ = loaderDuration;
  </script>
  {
    /*
    NOTE: We are using a hybrid loading strategy here. The first few rows of
    logos are loaded eagerly to feel instant, while the rest are lazy-loaded
    to balance performance and user experience.
  */
  }
  <!-- Hero Section -->
  <section class="relative">
    <Image
      src={clienteleHero}
      alt="Clientele Hero Background"
      loading={"eager"}
      class="w-full object-cover"
    />

    <!-- Heading positioned at bottom -->
    <h1
      class="absolute bottom-[11%] text-[#E5E2D6] font-[AcidGrotesk] font-light text-lg sm:text-3xl md:text-4xl lg:text-5xl xl:text-6xl"
      style="left: 9%;"
    >
      Our Clientele
    </h1>
  </section>

  <!-- Architects Section -->
  <section
    id="architects-section"
    class="flex flex-col items-center py-16 sm:py-20 md:py-24 lg:py-28 xl:py-32 space-y-6 sm:space-y-8 md:space-y-10"
  >
    <h2
      class="text-center font-[AcidGrotesk] font-light text-[#391B26] text-base sm:text-2xl md:text-3xl lg:text-4xl xl:text-5xl"
    >
      Architects
    </h2>
    <div
      class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-0 w-[85%] max-w-6xl"
    >
      {
        architectClients.map((client, index) => (
          <div class="flex items-center justify-center">
            <Image
              src={client}
              alt={`Architect Client ${index + 1}`}
              loading="eager"
              class="w-full h-auto"
            />
          </div>
        ))
      }
    </div>
  </section>

  <!-- Builders Section -->
  <section
    id="builders-section"
    class="flex flex-col items-center pb-16 sm:pb-20 md:pb-24 lg:pb-28 xl:pb-32 space-y-6 sm:space-y-8 md:space-y-10"
  >
    <h2
      class="text-center font-[AcidGrotesk] font-light text-[#391B26] text-base sm:text-2xl md:text-3xl lg:text-4xl xl:text-5xl"
    >
      Builders
    </h2>
    <div
      class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-0 w-[85%] max-w-6xl"
    >
      {
        builderClients.map((client, index) => (
          <div class="flex items-center justify-center">
            <Image
              src={client}
              alt={`Builder Client ${index + 1}`}
              loading="eager"
              class="w-full h-auto"
            />
          </div>
        ))
      }
    </div>
  </section>
</PageLayout>

<script>
  // This script uses the browser's idle time to pre-decode images section by section.
  // It runs after the page is interactive, so it doesn't block initial rendering.
  // By decoding images before they are scrolled into view, we can ensure they
  // appear instantly without jank.
  (function () {
    if (typeof window === "undefined") return;

    // A function to schedule work when the browser is idle.
    function scheduleIdleWork(
      callback: (
        deadline: IdleDeadline | { timeRemaining: () => number }
      ) => void
    ) {
      if ("requestIdleCallback" in window) {
        // Use requestIdleCallback with a timeout to ensure it eventually runs.
        window.requestIdleCallback(callback, { timeout: 2000 });
      } else {
        // Fallback for older browsers: run after a short delay.
        setTimeout(() => callback({ timeRemaining: () => 1 }), 500);
      }
    }

    // The function that finds and decodes images within a specific section.
    function warmImageSection(sectionId: string) {
      const sectionEl = document.getElementById(sectionId);
      if (!sectionEl) return;

      // Get all images within the section.
      const images = Array.from(sectionEl.querySelectorAll("img"));
      const promises = images.map((img) => {
        if (img && "decode" in img && !img.complete) {
          return img.decode().catch(() => {}); // Ignore individual errors
        }
        return Promise.resolve();
      });

      // Promise.allSettled waits for all promises to settle (either resolve or reject).
      // This allows us to know when the entire section is "ready".
      Promise.allSettled(promises).then(() => {
        // You could add a class or fire an event here if you wanted to
        // animate the section in after it's fully decoded.
        // For now, we just log it for demonstration.
        console.log(`${sectionId} decoded and ready.`);
      });
    }

    // Wait until the page is fully loaded before starting the process.
    window.addEventListener("load", () => {
      // We can process sections in parallel during the browser's idle time.
      scheduleIdleWork(() => {
        warmImageSection("architects-section");
        warmImageSection("builders-section");
      });
    });
  })();
</script>
