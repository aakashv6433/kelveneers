---
import { Image } from "astro:assets";
import PageLayout from "../layouts/PageLayout.astro";
import clienteleHero from "../assets/clientele_hero.png";

// Import all client logos (1-32)
import client1 from "../assets/clientele/compressed_for_the_clientele_page/1-min.png";
import client2 from "../assets/clientele/compressed_for_the_clientele_page/2-min.png";
import client3 from "../assets/clientele/compressed_for_the_clientele_page/3-min.png";
import client4 from "../assets/clientele/compressed_for_the_clientele_page/4-min.png";
import client5 from "../assets/clientele/compressed_for_the_clientele_page/5-min.png";
import client6 from "../assets/clientele/compressed_for_the_clientele_page/6-min.png";
import client7 from "../assets/clientele/compressed_for_the_clientele_page/7-min.png";
import client8 from "../assets/clientele/compressed_for_the_clientele_page/8-min.png";
import client9 from "../assets/clientele/compressed_for_the_clientele_page/9-min.png";
import client10 from "../assets/clientele/compressed_for_the_clientele_page/10-min.png";
import client11 from "../assets/clientele/compressed_for_the_clientele_page/11-min.png";
import client12 from "../assets/clientele/compressed_for_the_clientele_page/12-min.png";
import client13 from "../assets/clientele/compressed_for_the_clientele_page/13-min.png";
import client14 from "../assets/clientele/compressed_for_the_clientele_page/14-min.png";
import client15 from "../assets/clientele/compressed_for_the_clientele_page/15-min.png";
import client16 from "../assets/clientele/compressed_for_the_clientele_page/16-min.png";
import client17 from "../assets/clientele/compressed_for_the_clientele_page/17-min.png";
import client18 from "../assets/clientele/compressed_for_the_clientele_page/18-min.png";
import client19 from "../assets/clientele/compressed_for_the_clientele_page/19-min.png";
import client20 from "../assets/clientele/compressed_for_the_clientele_page/20-min.png";
import client21 from "../assets/clientele/compressed_for_the_clientele_page/21-min.png";
import client22 from "../assets/clientele/compressed_for_the_clientele_page/22-min.png";
import client23 from "../assets/clientele/compressed_for_the_clientele_page/23-min.png";
import client24 from "../assets/clientele/compressed_for_the_clientele_page/24-min.png";
import client25 from "../assets/clientele/compressed_for_the_clientele_page/25-min.png";
import client26 from "../assets/clientele/compressed_for_the_clientele_page/26-min.png";
import client27 from "../assets/clientele/compressed_for_the_clientele_page/27-min.png";
import client28 from "../assets/clientele/compressed_for_the_clientele_page/28-min.png";
import client29 from "../assets/clientele/compressed_for_the_clientele_page/29-min.png";
import client30 from "../assets/clientele/compressed_for_the_clientele_page/30-min.png";
import client31 from "../assets/clientele/compressed_for_the_clientele_page/31-min.png";
import client32 from "../assets/clientele/compressed_for_the_clientele_page/32-min.png";

const architectClients = [
  client1,
  client2,
  client3,
  client4,
  client5,
  client6,
  client7,
  client8,
  client9,
  client10,
  client11,
  client12,
  client13,
  client14,
  client15,
  client16,
];

const builderClients = [
  client17,
  client18,
  client19,
  client20,
  client21,
  client22,
  client23,
  client24,
  client25,
  client26,
  client27,
  client28,
  client29,
  client30,
  client31,
  client32,
];

// How many initial images to prioritize (first visible row)
const PRIORITY_COUNT = 4;
---

<PageLayout title="Clientele â€¢ Kelveneers">
  <!-- Hero Section -->
  <section class="relative">
    <Image
      src={clienteleHero}
      alt="Clientele Hero Background"
      loading="eager"
      priority={true}
      class="w-full object-cover"
    />

    <h1
      class="absolute bottom-[11%] left-[9%] text-[#E5E2D6] font-[AcidGrotesk] font-light text-lg sm:text-3xl md:text-4xl lg:text-5xl xl:text-6xl"
    >
      Our Clientele
    </h1>
  </section>

  <!-- Architects Section -->
  <section
    id="architects-section"
    class="flex flex-col items-center py-16 sm:py-20 md:py-24 lg:py-28 xl:py-32 space-y-6 sm:space-y-8 md:space-y-10"
  >
    <h2
      class="text-center font-[AcidGrotesk] font-light text-[#391B26] text-base sm:text-2xl md:text-3xl lg:text-4xl xl:text-5xl"
    >
      Architects
    </h2>
    <div
      class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-0 w-[85%] max-w-6xl"
    >
      {
        architectClients.map((client, index) => (
          <div
            class="flex items-center justify-center logo-item"
            data-index={index}
          >
            <Image
              src={client}
              alt={`Architect Client ${index + 1}`}
              loading={index < PRIORITY_COUNT ? "eager" : "lazy"}
              priority={index < PRIORITY_COUNT}
              widths={[200, 300, 400]}
              sizes="(max-width: 640px) 50vw, (max-width: 768px) 33vw, 25vw"
              quality={85}
              format="webp"
              class="w-full h-auto"
            />
          </div>
        ))
      }
    </div>
  </section>

  <!-- Builders Section -->
  <section
    id="builders-section"
    class="flex flex-col items-center pb-16 sm:pb-20 md:pb-24 lg:pb-28 xl:pb-32 space-y-6 sm:space-y-8 md:space-y-10"
  >
    <h2
      class="text-center font-[AcidGrotesk] font-light text-[#391B26] text-base sm:text-2xl md:text-3xl lg:text-4xl xl:text-5xl"
    >
      Builders
    </h2>
    <div
      class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-0 w-[85%] max-w-6xl"
    >
      {
        builderClients.map((client, index) => (
          <div
            class="flex items-center justify-center logo-item"
            data-index={index}
          >
            <Image
              src={client}
              alt={`Builder Client ${index + 1}`}
              loading={index < PRIORITY_COUNT ? "eager" : "lazy"}
              priority={index < PRIORITY_COUNT}
              widths={[200, 300, 400]}
              sizes="(max-width: 640px) 50vw, (max-width: 768px) 33vw, 25vw"
              quality={85}
              format="webp"
              class="w-full h-auto"
            />
          </div>
        ))
      }
    </div>
  </section>
</PageLayout>

<style>
  .logo-item {
    opacity: 0;
    transform: translateY(13px);
    transition:
      opacity 0.33s ease-out,
      transform 0.33s ease-out;
    position: relative;
    min-height: 80px; /* Placeholder height to prevent layout shift */
  }

  .logo-item img {
    display: block;
  }

  .logo-item.fade-in {
    opacity: 1;
    transform: translateY(0);
  }

  /* Slower, more graceful reveal on small screens */
  @media (max-width: 640px) {
    .logo-item {
      transition:
        opacity 0.48s ease-out,
        transform 0.48s ease-out;
      min-height: 60px;
    }
  }
</style>
<script>
  // Reset scroll position to top on page load/refresh
  if (history.scrollRestoration) {
    history.scrollRestoration = "manual";
  }
  window.scrollTo(0, 0);

  document.addEventListener("DOMContentLoaded", () => {
    const logoItems = Array.from(document.querySelectorAll(".logo-item"));

    // Accessibility: if user prefers reduced motion, reveal all immediately
    const prefersReduced =
      window.matchMedia &&
      window.matchMedia("(prefers-reduced-motion: reduce)").matches;
    if (prefersReduced) {
      logoItems.forEach((item) => item.classList.add("fade-in"));
      return;
    }

    // Determine reveal cadence by breakpoint
    const revealIntervalMs =
      window.innerWidth >= 768 ? 50 : window.innerWidth >= 640 ? 60 : 115;

    // Priority: only first 4 items load eagerly (visible above fold on most devices)
    const priorityCount = 4;

    // Immediately reveal the first few items
    logoItems.slice(0, priorityCount).forEach((item) => {
      item.classList.add("fade-in");
    });

    // Use Intersection Observer for performance - only animate when near viewport
    let currentIndex = priorityCount;
    let isAnimating = false;
    const animationQueue: HTMLElement[] = [];

    // Start animation chain for queued items
    function processQueue() {
      if (isAnimating || animationQueue.length === 0) return;

      isAnimating = true;
      const item = animationQueue.shift();
      if (!item) {
        isAnimating = false;
        return;
      }

      item.classList.add("fade-in");

      let settled = false;
      const onSettled = () => {
        if (settled) return;
        settled = true;
        isAnimating = false;
        setTimeout(processQueue, revealIntervalMs);
      };

      item.addEventListener(
        "transitionend",
        (ev) => {
          const prop = (ev as TransitionEvent).propertyName;
          if (prop === "opacity" || prop === "transform") {
            onSettled();
          }
        },
        { once: true }
      );

      // Fallback timeout
      setTimeout(onSettled, revealIntervalMs + 120);
    }

    // Observe items that haven't been revealed yet
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const item = entry.target as HTMLElement;

            // Stop observing this item
            observer.unobserve(item);

            // Add to animation queue if not already visible
            if (
              !item.classList.contains("fade-in") &&
              !animationQueue.includes(item)
            ) {
              animationQueue.push(item);
              processQueue();
            }
          }
        });
      },
      {
        // Start loading when item is 200px away from viewport
        rootMargin: "200px",
        threshold: 0,
      }
    );

    // Observe all items that aren't already visible
    logoItems.slice(priorityCount).forEach((item) => {
      observer.observe(item);
    });
  });
</script>
