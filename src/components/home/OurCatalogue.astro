---
import { Image } from "astro:assets";
import proj1 from "../../assets/our_catalogue/66-min.png";
import proj2 from "../../assets/our_catalogue/67-min.png";
import proj3 from "../../assets/our_catalogue/68-min.png";
import proj4 from "../../assets/our_catalogue/69-min.png";
import proj5 from "../../assets/our_catalogue/70-min.png";
import proj6 from "../../assets/our_catalogue/71-min.png";
import proj7 from "../../assets/our_catalogue/72-min.png";
import proj8 from "../../assets/our_catalogue/73-min.png";
import proj9 from "../../assets/our_catalogue/74-min.png";
import proj10 from "../../assets/our_catalogue/75-min.png";
import arrowOrange from "../../assets/our_offerings/arrow_right.svg";

const images = [
  proj1,
  proj2,
  proj3,
  proj4,
  proj5,
  proj6,
  proj7,
  proj8,
  proj9,
  proj10,
];
---

<section id="our-catalogue-section" class="px-[8.33vw] pb-[10vw]">
  <div class="border-t md:border-t-2 border-[#D6D0C7] w-[calc(100%+8.33vw)]">
  </div>
  <div class="w-full relative overflow-hidden aspect-video">
    <!-- Slides -->
    {
      images.map((src, i) => (
        <Image
          id={"catalogue-img-" + i}
          src={src}
          alt={"Catalogue " + (i + 1)}
          class={
            "w-full h-full object-contain object-left absolute inset-0 transition-opacity duration-700 ease-in-out " +
            (i === 0 ? "opacity-100" : "opacity-0")
          }
          loading={i <= 3 ? "eager" : "lazy"}
        />
      ))
    }

    <!-- Orange Arrow -->
    <div
      class="absolute left-[66.52%] top-[15%] z-10 -translate-x-1/2 -translate-y-1/2 cursor-pointer"
      id="catalogue-arrow-container"
    >
      <Image
        id="catalogue-arrow"
        src={arrowOrange}
        alt="Orange Arrow"
        class="w-7 h-7 min-[500px]:w-8 min-[500px]:h-8 sm:w-10 sm:h-10 md:w-12 md:h-12 lg:w-16 lg:h-16 xl:w-20 xl:h-20 transition-transform duration-200"
      />
    </div>

    <!-- Gradient Overlay -->
    <div
      class="absolute bottom-0 left-0 w-[66.52%] h-[30%] bg-gradient-to-b from-transparent to-black/70 pointer-events-none"
    >
    </div>

    <!-- Dots (lower on mobile, keep spacing on larger screens) -->
    <div
      class="absolute bottom-3 md:bottom-8 left-[33.26%] transform -translate-x-1/2 flex space-x-1 sm:space-x-2 lg:space-x-2.5"
    >
      {
        images.map((_, i) => (
          <div
            class={
              "w-1.5 h-1.5 sm:w-2 sm:h-2 md:w-2.5 md:h-2.5 lg:w-2.5 lg:h-2.5 rounded-full cursor-pointer" +
              (i === 0 ? " bg-[#F07A66]" : " bg-[#F07A66]/40")
            }
            data-index={i}
          />
        ))
      }
    </div>
  </div>
  <div class="border-b md:border-b-2 border-[#D6D0C7] w-[calc(100%+8.33vw)]">
  </div>
</section>

<script>
  // Use unique ID to scope all queries
  const section = document.getElementById("our-catalogue-section");
  const container = section ? section.querySelector("div") : null;

  const imageCount = 10;
  const imageIds = Array.from(
    { length: imageCount },
    (_, i) => "catalogue-img-" + i
  );
  const dots = section
    ? section.querySelectorAll<HTMLElement>("[data-index]")
    : [];
  const arrowBtn = section
    ? section.querySelector("#catalogue-arrow-container")
    : null;
  let current = 0;
  let touchStartX = 0;
  let touchEndX = 0;
  const AUTO_ADVANCE_MS = 5000;
  let autoAdvanceId: ReturnType<typeof setInterval> | null = null;

  function showSlide(index: number) {
    imageIds.forEach((id, i) => {
      const el = document.getElementById(id);
      if (!el) return;
      if (i === index) {
        el.classList.add("opacity-100");
        el.classList.remove("opacity-0");
      } else {
        el.classList.add("opacity-0");
        el.classList.remove("opacity-100");
      }
    });

    dots.forEach((dot, i) => {
      if (i === index) {
        dot.classList.remove("bg-[#F07A66]/40");
        dot.classList.add("bg-[#F07A66]");
      } else {
        dot.classList.remove("bg-[#F07A66]");
        dot.classList.add("bg-[#F07A66]/40");
      }
    });
  }

  function nextSlide() {
    current = (current + 1) % imageCount;
    showSlide(current);
  }

  function prevSlide() {
    current = (current - 1 + imageCount) % imageCount;
    showSlide(current);
  }

  function startAutoAdvance() {
    if (autoAdvanceId !== null) clearInterval(autoAdvanceId);
    autoAdvanceId = setInterval(nextSlide, AUTO_ADVANCE_MS);
  }

  function handleSwipe() {
    const swipeThreshold = 66;
    const diff = touchStartX - touchEndX;
    if (Math.abs(diff) > swipeThreshold) {
      if (diff > 0) nextSlide();
      else prevSlide();
      startAutoAdvance();
    }
  }

  // Dot clicks
  dots.forEach((dot) => {
    dot.addEventListener("click", () => {
      const idx = parseInt(dot.dataset.index ?? "");
      if (!Number.isNaN(idx)) {
        current = idx;
        showSlide(current);
        startAutoAdvance();
      }
    });
  });

  // Arrow click
  if (arrowBtn) {
    arrowBtn.addEventListener("click", () => {
      nextSlide();
      startAutoAdvance();
    });
  }

  // Touch events (container already defined at top)
  if (container) {
    container.addEventListener(
      "touchstart",
      (e) => {
        touchStartX = e.changedTouches[0].screenX;
      },
      false
    );

    container.addEventListener(
      "touchend",
      (e) => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
      },
      false
    );
  }

  // Initialize
  showSlide(current);
  startAutoAdvance();
</script>

<style>
  @media (hover: hover) {
    #catalogue-arrow:hover {
      transform: scale(1.15);
    }
  }
</style>
