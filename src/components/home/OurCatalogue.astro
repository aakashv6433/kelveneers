---
import { Image, getImage } from "astro:assets";
import ourCatalogueImage from "../../assets/ourcatalogue-homepage-min.png";
import windowSystemsImage from "../../assets/our_offerings/sub_cat_2-min.png";
import woodenDoorsImage from "../../assets/product-categories-section/door.png";
import framesImage from "../../assets/filip-kominik-IHtVbLRjTZU-unsplash.jpg"; // TODO: Replace with actual frames image
import iconImage1 from "../../assets/OurCatalogIcon1-min.png";
import iconImage2 from "../../assets/OurCatalogIcon2-min.png";
import iconImage3 from "../../assets/OurCatalogIcon3-min.png";

// Prepare image URLs for the client-side script with proper optimization
const imageUrls = await Promise.all([
  getImage({ src: windowSystemsImage }),
  getImage({ src: woodenDoorsImage }),
  getImage({ src: framesImage }),
]);
---

<section>
  <div class="flex pl-[8.33vw] pb-8 md:pb-[10vw]">
    <div class="basis-2/3 relative">
      <Image
        src={ourCatalogueImage}
        alt="House"
        loading={"lazy"}
        class="w-full h-auto"
      />

      <!-- Interactive icons -->
      <div class="absolute inset-0">
        <!-- First icon positioned on the left -->
        <div
          class="absolute w-7 h-7 sm:w-9 sm:h-9 md:w-11 md:h-11 lg:w-13 lg:h-13 xl:w-15 xl:h-15 cursor-pointer hover-scale-118 transition-transform duration-200"
          style="top: 19%; left: 38%;"
          data-category="0"
          title="Window Systems"
        >
          <Image
            src={iconImage1}
            alt="Window Systems Icon"
            class="w-full h-full"
            loading="lazy"
          />
        </div>

        <!-- Second icon positioned on the left -->
        <div
          class="absolute w-7 h-7 sm:w-9 sm:h-9 md:w-11 md:h-11 lg:w-13 lg:h-13 xl:w-15 xl:h-15 cursor-pointer hover-scale-118 transition-transform duration-200"
          style="top: 65%; left: 26%;"
          data-category="1"
          title="Wooden Doors"
        >
          <Image
            src={iconImage2}
            alt="Wooden Doors Icon"
            class="w-full h-full"
            loading="lazy"
          />
        </div>

        <!-- Third icon positioned on the right -->
        <div
          class="absolute w-7 h-7 sm:w-9 sm:h-9 md:w-11 md:h-11 lg:w-13 lg:h-13 xl:w-15 xl:h-15 cursor-pointer hover-scale-118 transition-transform duration-200"
          style="top: 60%; right: 24%;"
          data-category="2"
          title="Frames"
        >
          <Image
            src={iconImage3}
            alt="Frames Icon"
            class="w-full h-full"
            loading="lazy"
          />
        </div>
      </div>
    </div>
    <div
      class="basis-1/3 border border-[#E5E2D6] flex flex-col justify-between"
    >
      <div
        class="flex-1 flex px-5 sm:px-6 lg:px-8 xl:px-9 2xl:px-10 items-center justify-center"
      >
        <Image
          src={windowSystemsImage}
          alt="Product Category"
          class="w-full h-auto opacity-0 transition-opacity duration-300"
          id="catalogue-image"
          loading="lazy"
        />
      </div>
      <h2
        class="font-[AcidGrotesk] font-light text-[#391B26] pl-2.5 pb-2.5 sm:pl-5 sm:pb-5 lg:pl-7 lg:pb-7 text-xxs-custom text-xs-custom text-lg sm:text-xl md:text-2xl lg:text-4xl xl:text-5xl"
      >
        Our Catalogue
      </h2>
    </div>
  </div>
</section>

<style>
  @media (hover: hover) {
    .hover-scale-118:hover {
      transform: scale(1.18);
    }
  }
  @media (hover: hover) and (min-width: 1024px) {
    .hover-scale-118:hover {
      transform: scale(1.24);
    }
  }
  @media (hover: hover) and (min-width: 1280px) {
    .hover-scale-118:hover {
      transform: scale(1.33);
    }
  }

  .active {
    transform: scale(1.22);
  }
</style>

<script define:vars={{ imageUrls }}>
  const icons = document.querySelectorAll("div[data-category]");
  const img = document.getElementById("catalogue-image");
  let activeCategoryIndex = -1;
  let isMobileDevice = () => window.innerWidth < 768; // md breakpoint

  // Track which images are loaded to avoid showing before ready
  const loadedImages = new Set();

  // Preload images asynchronously in the background without blocking page load
  imageUrls.forEach((optimizedImage, index) => {
    const loader = new Image();
    loader.onload = () => {
      loadedImages.add(index);
    };
    loader.src = optimizedImage.src;
  });

  function updateIconStates() {
    icons.forEach((icon, index) => {
      if (index === activeCategoryIndex) {
        icon.classList.add("active");
      } else {
        icon.classList.remove("active");
      }
    });
  }

  function updateImage(categoryIndex) {
    if (!img || !imageUrls[categoryIndex]) return;

    const optimizedImage = imageUrls[categoryIndex];

    img.src = "";
    img.style.opacity = "0";
    activeCategoryIndex = categoryIndex;

    if (loadedImages.has(categoryIndex)) {
      img.src = optimizedImage.src;
      img.style.opacity = "1";
    } else {
      const loader = new Image();
      loader.onload = () => {
        loadedImages.add(categoryIndex);
        img.src = optimizedImage.src;
        img.style.opacity = "1";
      };
      loader.src = optimizedImage.src;
    }
    updateIconStates();
  }

  function hideImage() {
    if (img && activeCategoryIndex === -1) {
      img.style.opacity = "0";
    }
    updateIconStates();
  }

  icons.forEach((icon) => {
    // Mouse events for desktop
    icon.addEventListener("mouseenter", () => {
      if (!isMobileDevice()) {
        const categoryIndex = parseInt(icon.dataset.category);
        updateImage(categoryIndex);
      }
    });

    icon.addEventListener("mouseleave", () => {
      if (!isMobileDevice()) {
        if (img) {
          img.style.opacity = "0";
          activeCategoryIndex = -1;
          updateIconStates();
        }
      }
    });

    // Touch events for mobile
    icon.addEventListener("touchstart", (e) => {
      e.preventDefault();
      const categoryIndex = parseInt(icon.dataset.category);
      updateImage(categoryIndex);
    });
  });

  // Hide image on mobile when tapping outside icons
  document.addEventListener("touchstart", (e) => {
    const isIconTapped = Array.from(icons).some((icon) =>
      icon.contains(e.target)
    );
    if (!isIconTapped && isMobileDevice()) {
      activeCategoryIndex = -1;
      hideImage();
    }
  });

  // Initialize icon states
  updateIconStates();
</script>
