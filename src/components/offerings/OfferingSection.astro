---
import OfferingItem from "./OfferingItem.astro";

export interface Props {
  title: string;
  items: string[];
  images: ImageMetadata[];
  imageAlt: string;
  itemUrls?: string[];
  defaultImage?: ImageMetadata;
  paddingTop?: string;
  paddingBottom?: string;
}

const {
  title,
  items,
  images,
  imageAlt,
  itemUrls,
  defaultImage,
  paddingTop = "pt-[4.165vw]",
  paddingBottom = "pb-[4.165vw]",
} = Astro.props;

// Prepare image URLs for the client-side script
const imageUrls = images.map((img) => img.src);
---

<div
  class={`offering-section flex w-full flex-col bg-[#3A1A25] ${paddingTop} ${paddingBottom} px-[8.33vw]`}
>
  <div class="md:grid md:grid-cols-[6fr_7fr] gap-6 sm:gap-8 md:gap-16">
    <div
      class="flex flex-col gap-6 sm:gap-8 md:justify-between w-full md:w-[85%]"
    >
      <div class="text-center md:text-left">
        <h3
          class="font-[AcidGrotesk] font-light text-[#F0F1F2] text-lg sm:text-2xl md:text-3xl lg:text-4xl xl:text-5xl whitespace-nowrap"
        >
          {title}
        </h3>
      </div>
      <div class="w-full sm:w-[85%] md:hidden overflow-hidden ml-auto mr-0">
        <img
          src={defaultImage ? defaultImage.src : images[0].src}
          alt={imageAlt}
          class="w-full h-full aspect-square object-cover"
          id={`offering-image-mobile-${title.replace(/\s+/g, "-").toLowerCase()}`}
          loading="lazy"
        />
      </div>
      <div>
        <ul>
          {
            items.map((item, index) => (
              <OfferingItem text={item} index={index} url={itemUrls?.[index]} />
            ))
          }
        </ul>
      </div>
    </div>
    <div
      class="hidden md:block w-full sm:w-[85%] md:w-[70%] overflow-hidden ml-auto mr-0"
    >
      <img
        src={defaultImage ? defaultImage.src : images[0].src}
        alt={imageAlt}
        class="w-full h-full aspect-square object-cover"
        id={`offering-image-${title.replace(/\s+/g, "-").toLowerCase()}`}
        loading="lazy"
      />
    </div>
  </div>
</div>

<script define:vars={{ imageUrls, title, defaultImage }}>
  const isLargeScreen = window.matchMedia("(min-width: 1024px)").matches;

  const sectionId = title.replace(/\s+/g, "-").toLowerCase();
  const section = document.querySelector(
    `.offering-section:has(#offering-image-${sectionId})`
  );

  if (section) {
    const lis = section.querySelectorAll("li[data-item]");
    const img = section.querySelector(`#offering-image-${sectionId}`);
    const defaultImageUrl = defaultImage ? defaultImage.src : null;

    let selectedIndex = -1;

    function updateSelection(shouldChangeImage = false) {
      lis.forEach((li, i) => {
        const textSpan = li.querySelector("span:first-child");
        const arrowSpan = li.querySelector("span:last-child");
        if (i === selectedIndex) {
          textSpan.style.color = "#EB7D66";
          arrowSpan.style.color = "#EB7D66";
          if (isLargeScreen) {
            arrowSpan.style.transform = "scale(1.6)";
          }
        } else {
          textSpan.style.color = "#F0F1F2";
          arrowSpan.style.color = "#F0F1F2";
          arrowSpan.style.transform = "scale(1)";
        }
      });

      // Only change image if allowed and on lg+ screens
      if (shouldChangeImage && img) {
        const imageIndex =
          selectedIndex >= 0 ? selectedIndex : defaultImageUrl ? -1 : 0;
        if (imageIndex === -1) {
          if (defaultImageUrl) {
            img.src = defaultImageUrl;
          }
        } else {
          if (imageUrls[imageIndex]) {
            img.src = imageUrls[imageIndex];
          }
        }
      }
    }

    // Detect if device supports touch
    const isTouchDevice = () => {
      return (
        "ontouchstart" in window ||
        navigator.maxTouchPoints > 0 ||
        navigator.msMaxTouchPoints > 0
      );
    };

    // Only add hover listeners on non-touch devices
    if (!isTouchDevice()) {
      if (isLargeScreen) {
        // Handle hover for lg+ screens: image change and highlight
        lis.forEach((li, index) => {
          li.addEventListener("mouseover", () => {
            selectedIndex = index;
            updateSelection(true);
          });
          li.addEventListener("mouseout", () => {
            selectedIndex = -1;
            updateSelection(true);
          });
        });
      } else {
        // Handle hover for smaller screens with mouse: color change only
        lis.forEach((li, index) => {
          li.addEventListener("mouseover", () => {
            selectedIndex = index;
            updateSelection(false);
          });
          li.addEventListener("mouseout", () => {
            selectedIndex = -1;
            updateSelection(false);
          });
        });
      }
    }

    // Set default state
    updateSelection(false);
  }
</script>
